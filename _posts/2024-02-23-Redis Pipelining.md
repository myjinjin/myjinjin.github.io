---
layout: post
title: "[Redis] Redis νμ΄ν”„λΌμ΄λ‹(Pipelining)"
date: 2024-02-22 15:00:00
categories: Redis
---

---

## Redis νμ΄ν”„λΌμ΄λ‹μ΄λ€

- Redis νμ΄ν”„λΌμ΄λ‹μ€ Redis λ…λ Ήμ„ <span class="important">
μΌκ΄„ μ²λ¦¬</span>ν•μ—¬ μ™•λ³µ μ‹κ°„μ„ μµμ ν™”ν•λ” λ°©λ²•μ΄λ‹¤.
- κ°λ³„ λ…λ Ήμ— λ€ν• μ‘λ‹µμ„ κΈ°λ‹¤λ¦¬μ§€ μ•κ³  μ—¬λ¬ λ…λ Ήμ„ ν• λ²μ— μ‹¤ν–‰ν•μ—¬ <span class="important">μ„±λ¥μ„ κ°μ„ </span>ν•λ” κΈ°μ μ΄λ‹¤.

---

## μ”μ²­/μ‘λ‹µ ν”„λ΅ν† μ½κ³Ό μ™•λ³µ μ‹κ°„(RTT)

Redisλ” ν΄λΌμ΄μ–ΈνΈ-μ„λ²„ λ¨λΈκ³Ό μ”μ²­/μ‘λ‹µ ν”„λ΅ν† μ½μ„ μ‚¬μ©ν•λ” TCP μ„λ²„μ΄λ‹¤. μΌλ°μ μΌλ΅ μ”μ²­μ€ λ‹¤μ λ‹¨κ³„λ΅ μ΄λ£¨μ–΄μ§„λ‹¤.

1. ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ— μΏΌλ¦¬λ¥Ό λ³΄λ‚΄κ³ , λ³΄ν†µ λΈ”λ΅ν‚Ή λ°©μ‹μΌλ΅ μ†μΌ“μ—μ„ μ„λ²„ μ‘λ‹µμ„ μ½λ”λ‹¤.
2. μ„λ²„λ” λ…λ Ήμ„ μ²λ¦¬ν•κ³  μ‘λ‹µμ„ ν΄λΌμ΄μ–ΈνΈλ΅ λ‹¤μ‹ λ³΄λ‚Έλ‹¤.

μλ¥Ό λ“¤μ–΄ λ„¤ κ°μ λ…λ Ή μ‹ν€€μ¤λ” λ‹¤μκ³Ό κ°™λ‹¤.
```bash
Client: INCR X
Server: 1
Client: INCR X
Server: 2
Client: INCR X
Server: 3
Client: INCR X
Server: 4
```
ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„λ” λ„¤νΈμ›ν¬ λ§ν¬λ¥Ό ν†µν•΄ μ—°κ²°λλ‹¤. λ§ν¬λ” λ§¤μ° λΉ λ¥΄κ±°λ‚(λ£¨ν”„λ°± μΈν„°νμ΄μ¤) λ§¤μ° λλ¦΄(λ‘ νΈμ¤νΈ μ‚¬μ΄μ— λ§μ€ ν™‰μ΄ μλ” μΈν„°λ„·μ„ ν†µν•΄ μ„¤μ •λ μ—°κ²°) μ μλ‹¤. 

λ„¤νΈμ›ν¬ μ§€μ—° μ‹κ°„μ— μƒκ΄€μ—†μ΄ ν¨ν‚·μ΄ ν΄λΌμ΄μ–ΈνΈμ—μ„ μ„λ²„λ΅ μ΄λ™ν•κ³  μ„λ²„μ—μ„ ν΄λΌμ΄μ–ΈνΈλ΅ λ‹¤μ‹ λμ•„μ™€ μ‘λ‹µμ„ μ „λ‹¬ν•λ” λ°λ” μ‹κ°„μ΄ κ±Έλ¦°λ‹¤. μ΄ μ‹κ°„μ„ <span class="important">μ™•λ³µ μ‹κ°„</span>(RTT, Round Trip Time)μ΄λΌκ³  ν•λ‹¤.

ν΄λΌμ΄μ–ΈνΈκ°€ μ—°μ†μ μΌλ΅ λ§μ€ μ”μ²­μ„ μν–‰ν•΄μ•Ό ν•  λ•, μλ¥Ό λ“¤μ–΄ ν• λ¦¬μ¤νΈμ— λ§μ€ ν•­λ©μ„ μ¶”κ°€ν•κ±°λ‚ λ§μ€ ν‚¤λ΅ λ°μ΄ν„°λ² μ΄μ¤λ¥Ό μ±„μ°λ” κ²½μ°, RTTκ°€ μ„±λ¥μ— μ–΄λ–»κ² μν–¥μ„ λ―ΈμΉ  μ μλ”μ§€ μ‰½κ² μ΄ν•΄ν•  μ μλ‹¤. μλ¥Ό λ“¤μ–΄, RTT μ‹κ°„μ΄ 250λ°€λ¦¬μ΄μΈ κ²½μ°(μΈν„°λ„·μ„ ν†µν• λ§¤μ° λλ¦° λ§ν¬μ κ²½μ°), μ„λ²„κ°€ μ΄λ‹Ή 100,000κ°μ μ”μ²­μ„ μ²λ¦¬ν•  μ μλ‹¤κ³  ν•λ”λΌλ„, μµλ€ 4κ°μ μ”μ²­λ§ μ²λ¦¬ν•  μ μλ‹¤.

μ‚¬μ©λλ” μΈν„°νμ΄μ¤κ°€ λ£¨ν”„λ°± μΈν„°νμ΄μ¤μΈ κ²½μ°, RTTλ” μΌλ°μ μΌλ΅ λ°€λ¦¬μ΄ λ―Έλ§μΌλ΅ ν›¨μ”¬ μ§§μ§€λ§, μ—°μ†μΌλ΅ λ§μ€ μ“°κΈ° μ‘μ—…μ„ ν•΄μ•Όν•λ” κ²½μ°μ—λ” μ΄λ§μ €λ„ μ‹κ°„μ΄ λ§μ΄ λμ–΄λ‚λ‹¤.

λ‹¤ν–‰ν μ΄ μ‚¬μ© μ‚¬λ΅€λ¥Ό κ°μ„ ν•  μ μλ” λ°©λ²•μ΄ μλ‹¤.

---

## Redis νμ΄ν”„λΌμ΄λ‹(Pipelining)

μ”μ²­/μ‘λ‹µ μ„λ²„λ” μ΄μ „ μ‘λ‹µμ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ•„μ§ μ½μ§€ μ•μ•λ”λΌλ„ μƒλ΅μ΄ μ”μ²­μ„ μ²λ¦¬ν•  μ μλ” λ°©μ‹μΌλ΅ κµ¬ν„λ  μ μλ‹¤. μ΄λ ‡κ² ν•λ©΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ΄μ „ μ‘λ‹µμ„ κΈ°λ‹¤λ¦¬μ§€ μ•κ³ λ„ μ„λ²„μ— μ—¬λ¬μ„ λ…λ Ή μ „μ†΅ν•κ³  ν• λ²μ— μ‘λ‹µμ„ μ½μ„ μ μλ‹¤.

μ΄λ¥Ό νμ΄ν”„λΌμ΄λ‹μ΄λΌκ³  ν•λ‹¤. μ΄λ” μμ‹­ λ…„ λ™μ• λ„λ¦¬ μ‚¬μ©λκ³  μλ” κΈ°μ μ΄λ‹¤. μλ¥Ό λ“¤μ–΄, λ§μ€ POP3 ν”„λ΅ν† μ½ κµ¬ν„μ—μ„λ” μ΄λ―Έ νμ΄ν”„λΌμ΄λ‹ κΈ°λ¥μ„ μ§€μ›ν•κ³  μμΌλ©°, μ΄λ¥Ό ν†µν•΄ μ„λ²„λ΅λ¶€ν„° μƒ μ΄λ©”μΌμ„ λ‹¤μ΄λ΅λ“ν•λ” κ³Όμ •μ΄ ν„μ €ν•κ² κ°€μ†ν™”λμ—λ‹¤.

Redisλ” μ΄κΈ° λ²„μ „λ¶€ν„° νμ΄ν”„λΌμ΄λ‹μ„ μ§€μ›ν•΄μ™”μΌλ―€λ΅, μ‹¤ν–‰ μ¤‘μΈ λ²„μ „μ— κ΄€κ³„μ—†μ΄ Redisμ™€ ν•¨κ» νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•  μ μλ‹¤. λ‹¤μμ€ netcat μ ν‹Έλ¦¬ν‹°λ¥Ό μ‚¬μ©ν• μμ‹μ΄λ‹¤.

```bash
$ (printf "PING\r\nPING\r\nPING\r\n"; sleep 1) | nc localhost 6379
+PONG
+PONG
+PONG
```

μ΄λ²μ—λ” κ° νΈμ¶λ§λ‹¤ RTT λΉ„μ©μ„ μ§€λ¶ν•λ” κ²ƒμ΄ μ•„λ‹λΌ μ„Έ κ°μ λ…λ Ήμ— λ€ν•΄ ν• λ²λ§ RTT λΉ„μ©μ„ μ§€λ¶ν•λ‹¤.

λ…ν™•ν•κ² μ„¤λ…ν•μλ©΄, νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•λ©΄ μ²« λ²μ§Έ μμ μ μ‘μ—… μμ„λ” λ‹¤μκ³Ό κ°™λ‹¤.

```bash
Client: INCR X
Client: INCR X
Client: INCR X
Client: INCR X
Server: 1
Server: 2
Server: 3
Server: 4
```

> μ°Έκ³ π’΅
>
>ν΄λΌμ΄μ–ΈνΈκ°€ νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•μ—¬ λ…λ Ήμ„ μ „μ†΅ν•λ” λ™μ•, μ„λ²„λ” λ©”λ¨λ¦¬λ¥Ό μ‚¬μ©ν•μ—¬ μ‘λ‹µμ„ κ°•μ λ΅ λ€κΈ°μ—΄μ— λ„£μ–΄μ•Ό ν•λ‹¤. λ”°λΌμ„ νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•μ—¬ λ§μ€ λ…λ Ήμ„ λ³΄λ‚΄μ•Ό ν•λ” κ²½μ°μ—λ” κ°κ° μ μ ν• μ(μ: 10,000κ°μ λ…λ Ή)λ¥Ό ν¬ν•¨ν•λ” μΌκ΄„ μ²λ¦¬λ¥Ό λ³΄λ‚΄κ³ , μ‘λ‹µμ„ μ½μ€ λ‹¤μ λ‹¤μ‹ 10,000κ°μ λ…λ Ήμ„ λ³΄λ‚΄λ” μ‹μΌλ΅ λ³΄λ‚΄λ” κ²ƒμ΄ μΆ‹λ‹¤. μ†λ„λ” κ±°μ λ™μΌν•μ§€λ§ μ¶”κ°€λ΅ μ‚¬μ©λλ” λ©”λ¨λ¦¬λ” μ΄ 10,000κ°μ λ…λ Ήμ— λ€ν• μ‘λ‹µμ„ λ€κΈ°μ—΄μ— λ€κΈ°μ‹ν‚¤λ” λ° ν•„μ”ν• μ–‘λ§νΌλ§ λμ–΄λ‚λ‹¤.

---

## RTTλ§μ΄ λ¬Έμ κ°€ μ•„λ‹λ‹¤!

νμ΄ν”„λΌμ΄λ‹μ€ μ™•λ³µ μ‹κ°„κ³Ό κ΄€λ ¨λ μ§€μ—° λΉ„μ©μ„ μ¤„μ΄λ” λ°©λ²•μΌ λΏλ§ μ•„λ‹λΌ, μ‹¤μ λ΅ μ£Όμ–΄μ§„ Redis <span class="important">μ„λ²„μ—μ„ μ΄λ‹Ή μν–‰ν•  μ μλ” μ‘μ—… μλ¥Ό ν¬κ² ν–¥μƒ</span>μ‹ν‚¨λ‹¤. νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•μ§€ μ•μ„ λ•, κ°κ°μ λ…λ Ήμ„ μ²λ¦¬ν•λ” λ°λ” λ°μ΄ν„° κµ¬μ΅°μ— μ ‘κ·Όν•κ³  μ‘λ‹µμ„ μƒμ„±ν•λ” μΈ΅λ©΄μ—μ„λ” λΉ„κµμ  μ €λ ΄ν•μ§€λ§, μ†μΌ“ I/O μΈ΅λ©΄μ—μ„λ” λ§¤μ° λΉ„μ©μ΄ λ§μ΄ λ“¤κ² λλ‹¤. μ΄ μ‘μ—…μ—λ” `read()`μ™€ `write()` μ‹μ¤ν… νΈμ¶μ΄ ν¬ν•¨λμ–΄ μμΌλ©°, μ΄λ” μ μ € μμ—­κ³Ό μ»¤λ„ μμ—­ κ°„μ μ „ν™μ„ μλ―Έν•λ‹¤. μ΄ κ³Όμ •μ—μ„ λ°μƒν•λ” μ»¨ν…μ¤νΈ μ¤μ„μΉλ” μ†λ„λ¥Ό ν„μ €ν•κ² μ €ν•μ‹ν‚¨λ‹¤.

νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•λ©΄ μΌλ°μ μΌλ΅ μ—¬λ¬ λ…λ Ήμ΄ ν•λ‚μ `read()` μ‹μ¤ν… νΈμ¶λ΅ ν•κΊΌλ²μ— μ½νκ³ , μ—¬λ¬ μ‘λ‹µμ΄ ν•λ‚μ `write()` νΈμ¶λ΅ μ „μ†΅λλ‹¤. κ·Έ κ²°κ³Ό, μ΄κΈ°μ—λ” νμ΄ν”„λΌμΈμ΄ κΈΈμ–΄μ§μλ΅ μ΄λ‹Ή μ΄ μΏΌλ¦¬ μκ°€ κ±°μ μ„ ν•μ μΌλ΅ μ¦κ°€ν•κ³ , κ²°κµ­ μ•„λ κ·Έλ¦Όκ³Ό κ°™μ΄ νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•μ§€ μ•μ•μ„ λ•λ³΄λ‹¤ 10λ°° κ°€λ‰ λ†’μ€ μ„±λ¥μ„ μ–»μ„ μ μλ‹¤. 

![redis06-pipeline_iops](/assets/images/redis06-pipeline_iops.png)

---

## Code Example in Go

νμ΄ν”„λΌμ΄λ‹μ„ μ§€μ›ν•λ” Redis Go ν΄λΌμ΄μ–ΈνΈλ¥Ό μ‚¬μ©ν•μ—¬ νμ΄ν”„λΌμ΄λ‹μΌλ΅ μΈν• μ†λ„ ν–¥μƒμ„ ν…μ¤νΈν•΄λ³΄μ•λ‹¤.

```go
package main

import (
	"context"
	"fmt"
	"time"

	"github.com/redis/go-redis/v9"
)

var ctx = context.Background()

func bench(descr string, fn func()) {
	start := time.Now()
	fn()
	fmt.Printf("%s %v seconds\n", descr, time.Since(start))
}

func withoutPipelining() {
	rdb := redis.NewClient(&redis.Options{
		Addr: "localhost:6379",
	})
	for i := 0; i < 10000; i++ {
		rdb.Ping(ctx)
	}
}

func withPipelining() {
	rdb := redis.NewClient(&redis.Options{
		Addr: "localhost:6379",
	})
	pipe := rdb.Pipeline()
	for i := 0; i < 10000; i++ {
		pipe.Ping(ctx)
	}
	_, err := pipe.Exec(ctx)
	if err != nil {
		panic(err)
	}
}

func main() {
	bench("without pipelining", withoutPipelining)
	bench("with pipelining", withPipelining)
}
```

μ‹¤ν–‰ κ²°κ³Όλ” λ‹¤μκ³Ό κ°™λ‹¤.

```bash
ξ‚° go run main.go
without pipelining 668.024715ms seconds
with pipelining 9.112195ms seconds
```

νμ΄ν”„λΌμ΄λ‹μ„ μ‚¬μ©ν•μ—¬ μ „μ†΅ μ†λ„λ¥Ό ν–¥μƒμ‹μΌ°λ‹¤!

---

## κ²°λ΅ 

Redis νμ΄ν”„λΌμ΄λ‹(Pipelining)μ€ ν΄λΌμ΄μ–ΈνΈκ°€ λ¨λ“  λ…λ Ήμ„ ν• λ²μ— λ³΄λ‚΄κ³ , κ·Έ ν›„μ— μΌκ΄„μ μΌλ΅ λ¨λ“  μ‘λ‹µμ„ λ°›κΈ° λ•λ¬Έμ— λ„¤νΈμ›ν¬ μ¤λ²„ν—¤λ“λ¥Ό μ¤„μ΄κ³  μ²λ¦¬ μ†λ„λ¥Ό ν–¥μƒμ‹ν‚¬ μ μλ‹¤. μ΄λ¥Ό ν†µν•΄ λ€κ·λ¨ λ°μ΄ν„° μ²λ¦¬ λ° μ‘μ© ν”„λ΅κ·Έλ¨ μ„±λ¥μ„ ν–¥μƒμ‹ν‚¬ μ μλ‹¤. κ·Έλ¬λ‚ μ‘λ‹µ μμ„κ°€ λ³΄μ¥λμ§€ μ•κ³ , μ„λ²„μ λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ λμ–΄λ‚  μ μμΌλ―€λ΅ μ£Όμκ°€ ν•„μ”ν•λ‹¤.

---

- Reference: https://redis.io/docs/manual/pipelining/