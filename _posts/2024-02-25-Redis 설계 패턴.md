---
layout: post
title: "[Redis] Redis 설계 패턴 > Hash 데이터 타입"
date: 2024-02-24 15:00:00
categories: Redis
---

---

SQL 데이터베이스로 애플리케이션을 설계할 때 일반적인 방법은 모든 데이터를 테이블에 넣고 그 데이터를 쿼리하는 방법을 연구하는 것이다.

그러나 Redis를 사용할 때는 이와 반대로 접근해야 한다.

---

## Redis 설계 방법론

Redis는 설계할 때, 다음 두 가지 단계를 따르는 것이 중요하다.

1. 우리가 답변해야 하는 <span class="important">쿼리를 파악</span>한다.
	- 데이터베이스에서 어떤 종류의 질의에 답변해야 하는지 먼저 파악해야 한다.
	- 예를 들어, 사용자의 프로필 정보를 검색하거나 특정 시간 범위 내의 데이터를 얻는 등의 쿼리를 고려할 수 있다.
2. <span class="important">쿼리에 가장 적합한 형태로 데이터를 구조화</span>한다.
	- 정의한 쿼리에 가장 효율적으로 답변할 수 있도록 데이터를 구조화해야 한다.
	- 예를 들어, 특정 사용자의 프로필 정보를 빠르게 가져오기 위해 사용자 ID를 키로 하는 해시 형태로 데이터를 저장할 수 있다.

---

## 쿼리를 위한 설계

경매 사이트에 필요한 기능을 바탕으로 설계를 해보자.

### 필요한 쿼리 또는 작업

- 랜딩 페이지
	- 가격, 종료 시간, 조회수에 따라 정렬된 아이템 리스트 조회
	- 아이템 이름으로 검색
- 로그인 페이지
	- 유저네임으로 사용자 찾기
	- 인증 시스템
		- 세션 생성하기
		- 세션 찾기
		- 아이디에 해당하는 사용자 찾기
- 회원가입 페이지
	- 사용자 생성하기
- 아이템 생성 페이지
	- 아이템 생성하기
- 아이템 조회 페이지
	- 아이디로 아이템 조회
	- 아이템의 좋아요 수 조회
	- 아이템 좋아요 하기
	- 아이템 좋아요 취소하기
	- 해당 페이지를 보고 있는 사용자가 이 아이템을 좋아하는지 확인하기
	- 아이템 입찰 생성하기
	- 아이템 입찰 히스토리 조회
	- 아이템과 비슷한 아이템 리스트 조회
	- 아이템 조회수 올리기(조회는 사용자별로 고유하다. 사용자는 한 가지 아이템에 한 번의 조회만 만들 수 있다.)
- 판매자 프로필 페이지
	- 사용자가 좋아하는 아이템 리스트 조회
	- 서로 다른 두 사용자가 동시에 좋아하는 아이템 리스트 조회(로그인한 사용자와 다른 프로필의 사용자)
- 대시보드
	- 로그인한 사용자가 생성한 모든 아이템 리스트 조회(다양한 정렬 기준으로 정렬 가능)

위 요구사항을 충족하도록만 설계하면 된다! 앞으로 10년 후의 계획까지는 필요하지 않다. <span class="important">Redis의 사용 목적은 속도</span>이기 때문이다. 빠른 애플리케이션을 만들고, 경우에 따라 데이터 모델에서 약간의 유연성은 내려놓는 것이다. SQL 데이터베이스에 비하면 나중에 추가 기능을 구현하기는 어려울 수도 있다. 하지만 애플리케이션을 만들면서 SQL 데이터베이스를 사용하는 것보다 훨씬 빠를 것이다.

위 다양한 기능을 읽기 연산과 쓰기 연산으로 나누어 보면 다음과 같다.

![redis07-features_for_design](/assets/images/redis07-features_for_design.png)

---

### 설계를 위해 고려할 것

앱 내부의 모든 데이터를 어떻게 표현할 수 있을까?
우선 서로 다른 항목들을 어떻게 표현할 지 정해야 한다.

다음과 같이 저장해야 할 6개의 서로 다른 항목이 있다.

| Things in Our App... |
|----------------------|
| users                |
| sessions             |
| items                |
| bids                 |
| views                |
| likes                |

이 중 <span class="important">어떤 것을 해시(Hash)로 저장</span>해야 할까?

---

## 각 리소스의 데이터 타입 결정하기

### 해시(Hash)를 사용해야 하는 데이터 유형

- <span class="important">다양한 속성</span>이 묶인 레코드가 있는 경우
- 다양한 시나리오에서 한 번에 <span class="important">하나의 아이템만 접근</span>하는 경우
- 리스트를 <span class="important">여러 가지 기준으로 정렬해서 조회</span>하는 경우

`items`은 위 조건들에 해당한다. 따라서, 판매하고 있는 모든 각각의 아이템을 별도의 해시로 저장한다. 결과적으로 데이터베이스에 아주 많은 해시가 저장될 것이다. 각각은 단일 아이템을 나타낸다.

=> `items`, `users`, `sessions`

### 해시(Hash) 사용이 적절하지 않은 경우

아래 경우들은 해시보다 <span class="important">더 적합한 데이터 구조</span>로 표현할 수 있다!

- 저장하는 레코드가 카운트 목적으로만 사용하고 고유성 확인이 있는 경우
- 레코드가 하나 또는 두 개의 속성만 있는 경우
- 다른 레코드간의 관계 저장시에만 사용하는 경우
- 일종의 시계열 데이터만 저장하는 경우(예: 시간이 지나면서 변경되는 값 한 두 개에 대한 스냅샷)

=> `likes`, `views`, `bids`

---

## 결론

Redis 설계에서는 쿼리를 우선 고려하고 데이터를 적합한 구조로 저장해야 한다. 해시(Hash)는 다양한 속성이 묶인 레코드에 적합하며, 리스트를 정렬해야 할 경우 유용하다. 그러나 카운트 목적이나 간단한 속성의 경우 다른 데이터 구조를 고려하는 것이 좋다.